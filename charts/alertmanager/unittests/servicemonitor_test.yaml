suite: test servicemonitor
templates:
  - servicemonitor.yaml
tests:
  - it: should not render when disabled
    set:
      serviceMonitor.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render with defaults when enabled
    set:
      serviceMonitor.enabled: true
    release:
      name: am
      namespace: monitoring
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ServiceMonitor
      - equal:
          path: metadata.name
          value: am-alertmanager
      - equal:
          path: metadata.namespace
          value: monitoring
      - equal:
          path: spec.endpoints[0].port
          value: http
      - equal:
          path: spec.endpoints[0].path
          value: /metrics

  - it: should apply custom namespace and labels
    set:
      serviceMonitor.enabled: true
      serviceMonitor.namespace: observability
      serviceMonitor.additionalLabels:
        test-label: test-value
    asserts:
      - equal:
          path: metadata.namespace
          value: observability
      - equal:
          path: metadata.labels.test-label
          value: test-value
